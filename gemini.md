# プロジェクト構成分析: ps-sqlite

## 1. プロジェクト概要

このプロジェクトは、PowerShellスクリプトとSQLiteデータベースを中核としたデータ同期システムです。主な機能は、2つのCSVファイル（提供データ、現在データ）を読み込み、内容を比較・同期し、結果を新しいCSVファイルに出力することです。

最大の特徴は**設定駆動型アーキテクチャ**であり、システムの振る舞いの大部分が `config/data-sync-config.json` ファイルによって定義されます。これにより、コードを直接変更することなく、データスキーマの変更、同期ロジックの調整、フィルタリングルールの追加などが可能です。

## 2. コア技術

- **スクリプト言語**: PowerShell
- **データベース**: SQLite

`package.json` が存在しますが、これは主に開発支援ツール（例: `@anthropic-ai/claude-code`）の管理用であり、アプリケーションのコアロジックはPowerShellで実装されています。

## 3. 実行フロー

1.  **エントリーポイント**: `scripts/main.ps1` が実行の起点です。
2.  **設定読み込み**: `config/data-sync-config.json` を読み込み、全設定をロードします。
3.  **入力ファイル処理**:
    - 設定されたパスから「提供データ」と「現在データ」のCSVファイルを読み込みます。
    - 読み込んだファイルは、履歴として `data/` ディレクトリ配下にタイムスタンプ付きでコピーされます。
4.  **データフィルタリング**: 設定に基づき、不要なデータ行（例: 'Z'や'Y'で始まる職員番号）を除外します。
5.  **データベース処理**:
    - SQLiteデータベース (`database/data-sync.db`) 内に、設定ファイルで定義されたスキーマ（テーブル、カラム、インデックス）を動的に作成します。
    - フィルタリング後のデータを各テーブル（`provided_data`, `current_data`）にインポートします。
6.  **データ同期**:
    - 設定されたキー項目（`employee_id` と `user_id`）を基準に両テーブルを比較します。
    - 同期ロジックに基づき、各レコードに `ADD`, `UPDATE`, `DELETE`, `KEEP` のいずれかのアクションを決定します。
7.  **結果出力**:
    - 同期結果を `sync_result` テーブルに格納します。
    - `sync_result` テーブルの内容を、設定で指定された出力パスにCSVファイルとして書き出します。
    - 出力されたCSVも `data/output` に履歴として保存されます。

## 4. 設定ファイル (`config/data-sync-config.json`) 詳細

このファイルがプロジェクトの心臓部です。

### `file_paths`
- 入力CSV（provided, current）、出力CSV（output）のパスを定義します。
- 処理ファイルの履歴を保存するディレクトリもここで指定します。

### `csv_format`
- 入出力CSVファイルのエンコーディング（UTF-8）、区切り文字（`,`）、改行コードなどをテーブルごとに設定します。

### `tables`
- `provided_data`, `current_data`, `sync_result` の3つのテーブルのスキーマを定義します。
- 各テーブルのカラムについて、名前、データ型（`TEXT`, `INTEGER`等）、制約（`NOT NULL`, `UNIQUE`等）、CSVに含めるか否かを細かく設定できます。

### `sync_rules`
- 同期処理の核心となるロジックを定義します。
- **`key_columns`**: レコードを同一とみなすためのキーを指定します（例: `provided_data`の`employee_id`と`current_data`の`user_id`）。
- **`column_mappings`**: 2つの入力データを比較する際、どのカラム同士を比べるかを定義します。
- **`sync_result_mapping`**: 最終的な出力レコードの各カラムに、どのテーブルのどの項目を、どの優先順位で格納するかを定義します。これにより、「提供データを優先し、なければ現在データを使う」といった柔軟な設定が可能です。固定値を設定することもできます（例: `phone` カラムに常に "999-9999-9999" を設定）。

### `data_filters`
- 入力データから特定の条件に合う行を除外するためのルールを定義します。
- `exclude`（除外）ルールを `glob` パターン（例: `Z*`）で指定できます。

### `performance_settings`, `error_handling`, `logging`
- パフォーマンス（バッチサイズ、インデックス作成閾値）、エラー時のリトライ処理、ログ出力に関する詳細な設定が含まれています。

## 5. 主要スクリプト (`scripts/` ディレクトリ)

- **`main.ps1`**: 全体の処理フローを制御するメインスクリプト。
- **`config-utils.ps1`**: 設定ファイルの読み込みと検証を担当。
- **`sql-utils.ps1`**: 設定に基づいて動的にSQL文（`CREATE TABLE`, `INSERT`等）を生成・実行。
- **`sync-data.ps1`**: `sync_rules` に基づいてデータ同期処理を実行。
- **`file-utils.ps1`**: ファイルの読み書きや履歴保存を担当。
- **`data-filter-utils.ps1`**: データフィルタリング処理を担当。
- **`database.ps1`**: SQLiteデータベースの接続や操作を担当。
